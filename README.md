# 楽天メール自動クリックツール

Gmailに届く楽天メール内のリンクを自動的にクリックして、ポイント獲得などの作業を自動化するツールです。

## 📋 できること

- Gmailに届く楽天メールを自動で検索
- 画像を認識してクリックすべきリンクを自動判定
- リンクを自動クリック（ポイント獲得など）
- 楽天サイトへの自動ログイン
- クリック完了後、メールを自動削除（ゴミ箱へ移動）
- クリック対象が見つからない場合は未読に戻す（後で確認できる）
- 処理結果を画面に表示

## 🚀 はじめ方

### 1. 必要なソフトウェアのインストール

このツールを使用するには、以下が必要です：
- [Node.js](https://nodejs.org/) (バージョン18以上)

Node.jsをインストール後、ターミナル（コマンドプロンプト）で以下のコマンドを実行してください：

```bash
npm install
```

これでツールに必要な部品がすべてインストールされます。

### 2. 設定ファイルの準備

プロジェクトフォルダ内に`.env`というファイルを作成し、以下の情報を入力してください：

```env
# あなたのGmailアドレス
GMAIL_EMAIL=your-email@gmail.com

# あなたのGmailパスワード
GMAIL_PASSWORD=your-app-password

# あなたの楽天ユーザーID
RAKUTEN_USER_ID=your-rakuten-user-id

# あなたの楽天パスワード
RAKUTEN_PASSWORD=your-rakuten-password

# どのメールを処理するか（楽天からのメールのみ）
SEARCH_QUERY=from:rakuten in:inbox -in:trash -in:spam

# ブラウザを表示するか（初回はfalse推奨）
HEADLESS=false
```

### 3. クリック対象の画像を準備

クリックしたいボタンやリンクの画像を用意します：（デフォルトでいくつか用意されています）

1. プロジェクトフォルダ内の`images`フォルダを開く
2. クリックしたいボタンのスクリーンショットを撮影
3. PNG形式で保存して`images`フォルダに入れる

**ヒント**: 楽天メールのどのボタンをクリックするか、画像で判断します。複数の画像を入れておけば、どれかに一致したときクリックします。

## 🏃 使い方

### 初回実行（認証情報の保存）

初回実行時は、必ず`.env`ファイルで`HEADLESS=false`に設定してください：

```env
HEADLESS=false
```

ターミナル（コマンドプロンプト）でプロジェクトフォルダに移動し、以下のコマンドを実行してください：

```bash
npm start
```

ブラウザが自動的に開き、以下の処理が実行されます：

1. **Gmailにログイン**（画面が表示されるので、必要に応じて手動で認証を完了）
2. Gmail認証情報を`auth.json`に自動保存
3. 楽天メールを検索
4. メールを1通ずつ開く
5. 画像を認識してリンクをクリック
6. **楽天サイトへログイン**（初回のみ自動実行）
7. 楽天ログイン情報も`auth.json`に追加保存
8. クリック完了後、メールを削除
9. すべてのメール処理が完了したら結果を表示

**重要**: 初回ログイン時は「このデバイスを信頼する」を選択すると、認証情報が正しく保存されます。

### 2回目以降の実行（ヘッドレスモード）

初回実行で`auth.json`が作成されたら、2回目以降は`.env`ファイルで`HEADLESS=true`に設定できます：

```env
HEADLESS=true
```

これにより、以下のメリットがあります：

- **ブラウザを表示せずにバックグラウンドで実行**
- **Gmailログイン処理をスキップ**（保存された認証情報を使用）
- **楽天ログイン処理もスキップ**（保存された認証情報を使用）
- **より高速な実行**

再度`npm start`を実行すると、ブラウザが表示されずに自動処理が実行されます。

**注意**: 初回実行で楽天メールがない場合、楽天ログインは実行されません。その場合、2回目以降も楽天ログインが必要になります。楽天ログイン情報を保存するには、初回実行時に楽天メールが1通以上必要です。

## 📁 重要なフォルダとファイル

- **images/** - クリックしたい画像を入れるフォルダ
- **debug/** - うまくいかなかった画像が保存されるフォルダ（自動生成）
- **.env** - 設定ファイル（自分で作成）
- **auth.json** - 認証情報の保存ファイル（自動生成、初回実行後に作成される）

## 🔧 詳細設定（オプション）

`.env`ファイルで以下の設定も変更できます：

| 設定名 | 説明 | 初期値 |
|--------|------|--------|
| `SEARCH_QUERY` | 検索するメールの条件 | `from:rakuten in:inbox -in:trash -in:spam` |
| `HEADLESS` | ブラウザを表示しない | `false` |
| `IMAGE_MATCH_THRESHOLD` | 画像の一致率（0.0～1.0） | `0.8` |

**検索条件の例**:
- 未読のみ処理: `from:rakuten is:unread`
- 7日以内のメール: `from:rakuten newer_than:7d`

## 🐛 うまく動かないときは

### 画像が認識されない場合

1. **`debug`フォルダを確認**
   - マッチしなかった画像が自動保存されています
   - ファイル名に一致率（例: rate75 = 75%）が表示されます

2. **一致率を下げる**
   - `.env`ファイルで`IMAGE_MATCH_THRESHOLD`を下げてみてください
   ```env
   IMAGE_MATCH_THRESHOLD=0.75
   ```

3. **画像を撮り直す**
   - より正確なスクリーンショットを撮影
   - できるだけシンプルな画像にする

## 💡 どんな仕組み？

このツールは以下の順番で動作します：

1. **Gmailにログイン**
2. **楽天メールを検索**（設定した条件で）
3. **メールを1通ずつ処理**：
   - メールを開く
   - 用意した画像と一致するボタンを探す
   - **見つかった場合**: リンクをクリック → メールを削除
   - **見つからなかった場合**: メールを未読に戻す（後で確認できる）
4. **結果を表示**

### 認証情報の保存について

初回実行時に認証情報を`auth.json`に保存することで、2回目以降はヘッドレスモードで実行できます：

- **初回**: `HEADLESS=false`でブラウザを表示してログイン
  - Gmailにログイン → 認証情報を保存
  - 楽天メールを処理 → 楽天にログイン（必要な場合）→ 認証情報を追加保存
- **2回目以降**: `HEADLESS=true`でバックグラウンド実行
  - `auth.json`の認証情報を使用（GmailとRakutenの両方のログインをスキップ）
- Googleのボット検出を回避するため、この2段階の認証方式を採用しています

## ⚠️ 注意事項

- このツールは個人利用を想定しています
- GmailとRakutenの利用規約を守って使用してください
- パスワードは`.env`ファイルで管理し、他人に見せないでください
- `.env`ファイルは絶対にGitHubなどにアップロードしないでください

## 🔐 セキュリティ

- `.env`ファイルと`auth.json`には機密情報が含まれるため、厳重に管理してください
- 通常のパスワードではなく、必ずGoogleアプリパスワードを使用してください
- このツールはパスワードをログに出力しません
- `.env`と`auth.json`は`.gitignore`に含まれており、GitHubにアップロードされません

## よくある質問

### Q: ブラウザを表示せずに実行できますか？

A: はい。ただし**初回実行時は必ず`HEADLESS=false`に設定してください**。初回実行で`auth.json`が作成された後、2回目以降は`HEADLESS=true`に変更してバックグラウンドで実行できます。

### Q: 複数のGmailアカウントで使えますか？

A: 現在のバージョンでは1つのアカウントのみ対応しています。別のアカウントで使う場合は`.env`ファイルを書き換えてください。

### Q: クリック後のメールはどうなりますか？

A: クリック成功後は自動的にゴミ箱に移動します（30日後に自動削除）。クリック対象が見つからなかった場合は未読に戻されます。

## 🤖 GitHub Actionsでの定期実行

GitHub Actionsを使用して、このツールを定期的に自動実行できます。

### セットアップ手順

#### 1. リポジトリをGitHubにプッシュ

プロジェクトをGitHubリポジトリにプッシュしてください：

```bash
git init
git add .
git commit -m "Initial commit"
git branch -M main
git remote add origin https://github.com/YOUR_USERNAME/auto-click-rakuten-mail.git
git push -u origin main
```

**重要**: `.env`と`auth.json`は`.gitignore`に含まれているため、GitHubにアップロードされません。

#### 2. ローカルでauth.jsonを生成

GitHub Actionsで実行する前に、ローカル環境で認証情報を保存する必要があります：

1. ローカルで非headlessモードで一度実行してauth.jsonを生成:
   ```bash
   HEADLESS=false npm start
   ```
2. ログインが成功すると、プロジェクトルートに`auth.json`が生成されます

#### 3. auth.jsonをGitHub Secretsに保存

1. auth.jsonをbase64エンコード:
   ```bash
   npm run encode-auth
   ```
2. `auth.json.base64`ファイルが生成されるので、中身をコピー
3. GitHubリポジトリで **Settings** → **Secrets and variables** → **Actions** を開く
4. **New repository secret** をクリック
5. 以下のSecretsを追加：

| Name | Value |
|------|-------|
| `AUTH_JSON_BASE64` | `auth.json.base64`の内容（base64エンコード済み） |
| `GMAIL_EMAIL` | あなたのGmailアドレス（フォールバック用） |
| `GMAIL_PASSWORD` | Gmailアプリパスワード（フォールバック用） |
| `RAKUTEN_USER_ID` | 楽天ユーザーID（フォールバック用） |
| `RAKUTEN_PASSWORD` | 楽天パスワード（フォールバック用） |

**重要**: `AUTH_JSON_BASE64`が設定されていれば、Gmail/楽天への毎回のログインは不要になります。

#### 4. 認証情報の更新（セッション有効期限切れ時）

auth.jsonのセッション有効期限が切れた場合、GitHub Actions実行が失敗します。その場合：

1. ローカルで再度ログイン:
   ```bash
   HEADLESS=false npm start
   ```
2. 新しいauth.jsonをエンコード:
   ```bash
   npm run encode-auth
   ```
3. GitHub Secretsの`AUTH_JSON_BASE64`を新しい値で更新

#### 5. GitHub Variablesの設定（オプション）

デフォルト値と異なる設定にしたい場合は、Variablesを設定します：

1. **Settings** → **Secrets and variables** → **Actions** → **Variables** タブを開く
2. **New repository variable** をクリック
3. 以下のVariablesを必要に応じて追加：

| Name | Default Value | Description |
|------|---------------|-------------|
| `SEARCH_QUERY` | `from:rakuten in:inbox -in:trash -in:spam` | メール検索条件 |
| `IMAGE_MATCH_THRESHOLD` | `0.8` | 画像マッチング閾値 |
| `PIXEL_MATCH_THRESHOLD` | `0.1` | ピクセルマッチング閾値 |

**注意**: これらのVariablesは設定しなくてもデフォルト値が使用されます。

#### 6. ワークフローの実行

ワークフローファイル（`.github/workflows/rakuten-auto-click.yml`）はすでに含まれています。

**自動実行スケジュール**:
- デフォルト: 毎日日本時間 9:00（UTC 0:00）に実行
- スケジュールを変更したい場合は、ワークフローファイルの`cron`設定を編集してください

**手動実行**:
1. リポジトリページで **Actions** タブを開く
2. **Rakuten Mail Auto Click** ワークフローを選択
3. **Run workflow** ボタンをクリック
4. **Run workflow** を確認

#### 7. 実行結果の確認

1. **Actions** タブで実行状況を確認
2. 各ワークフローをクリックすると詳細ログが表示されます
3. エラーが発生した場合、デバッグ用のスクリーンショットが自動的にアップロードされます

### GitHub Actions実行の仕組み

**ローカル実行との違い**:
- **認証**: GitHub Secretsから`AUTH_JSON_BASE64`を復元して使用（ログイン処理をスキップ）
- **ブラウザ**: ヘッドレスモード（`HEADLESS=true`）で実行
- **環境変数**: GitHub SecretsとVariablesから読み込み

**セキュリティ**:
- Secretsは暗号化されて保存されます
- ログにはパスワードや認証情報が表示されません（自動マスキング）
- `auth.json`は実行時にSecretsから復元され、実行後に破棄されます
- リポジトリには`auth.json`がコミットされません（`.gitignore`で除外）

**パフォーマンス**:
- auth.json方式により、毎回のログイン処理が不要
- 50通のメール処理が約8.6分で完了（要件の10分以内を達成）

### トラブルシューティング

**Q: ワークフローが失敗します**

A: 以下を確認してください：
1. `AUTH_JSON_BASE64`が正しく設定されているか
2. auth.jsonのセッション有効期限が切れていないか（切れている場合は再生成が必要）
3. GitHub Secretsがすべて正しく設定されているか
4. Actionsタブのログでエラー内容を確認

**Q: セッション有効期限はどのくらいですか？**

A: Gmailと楽天のセッション有効期限は通常数週間～数ヶ月です。有効期限が切れた場合、GitHub Actions実行が失敗するので、その際はローカルで再度ログインして`AUTH_JSON_BASE64`を更新してください。

**Q: スケジュール実行の時間を変更したい**

A: `.github/workflows/rakuten-auto-click.yml`ファイルの`cron`設定を変更してください：
```yaml
schedule:
  - cron: '0 12 * * *'  # 日本時間21:00（UTC 12:00）
```

---

**作成者**: hatohato25@gmail.com
**ライセンス**: MIT
